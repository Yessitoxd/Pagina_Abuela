<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — La Abuela</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;700&display=swap" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="abuela.png">
  <style>
    /* Keep project fonts/colors: Montserrat + neutral palette */
    body{font-family:Montserrat,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#ffffff;color:#111}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
    h1{margin:0 0 1rem}
    label{display:block;margin:.5rem 0;font-weight:700;color:#333}
    input[type=text],input[type=password],input[type=url]{width:100%;padding:.6rem;border:1px solid #ddd;border-radius:8px;background:#fff}
    button{padding:.6rem .9rem;border-radius:8px;border:0;background:#111;color:#fff;cursor:pointer}
    .muted{color:#666;font-size:.95rem}
    .controls{display:flex;gap:.5rem;margin-top:.6rem}
    .images{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:1rem}
    .images img{width:160px;height:120px;object-fit:cover;border-radius:6px;border:1px solid #ddd}

    /* Login card centered */
    .login-card{width:100%;max-width:420px;background:#fff;border:2px solid rgba(0,0,0,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.08);border-radius:12px;padding:1.4rem}
    .login-title{text-align:center;font-weight:700;margin-bottom:0.6rem}
    .login-sub{font-size:0.95rem;color:#666;text-align:center;margin-bottom:1rem}
    .primary{background:#111;color:#fff}
    .secondary{background:#fff;color:#111;border:2px solid #111}
    .controls{justify-content:flex-start}

    .upload-area{margin-top:1rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="login-card" role="form" aria-label="Ingreso Administrador">
      <h2 class="login-title">Ingreso Administrador</h2>
      <p class="login-sub">Introduce tus credenciales para acceder al panel</p>
  <p class="muted" style="font-size:.9rem;margin-top:.3rem">Nota: Este panel lee los usuarios administradores desde el backend desplegado en <code>https://pagina-abuela.onrender.com</code></p>
      <label for="user">Usuario</label>
      <input id="user" type="text" placeholder="Usuario" autocomplete="username" />
      <label for="pass">Contraseña</label>
      <input id="pass" type="password" placeholder="Contraseña" autocomplete="current-password" />
      <div class="controls" style="margin-top:12px">
        <button id="btnLogin" class="primary">Iniciar Sesión</button>
        <button id="btnRegister" class="secondary" style="margin-left:8px">Registrar</button>
      </div>
      <p id="loginMsg" class="muted" style="margin-top:.6rem"></p>
    </div>

    <section id="adminSection" style="display:none">
      <div style="display:flex;justify-content:flex-end;margin-bottom:.6rem">
        <button id="btnLogout" style="display:none;background:#666;padding:.5rem .8rem;border-radius:8px;color:#fff;border:0">Cerrar sesión</button>
      </div>
      <p id="adminWelcome" style="font-weight:700;margin-bottom:.6rem;display:none">Aquí subes fotos</p>
      <h2>Subir foto</h2>
      <form id="uploadForm">
        <label>Selecciona una imagen</label>
        <input id="fileInput" type="file" accept="image/*" style="display:none" />
        <div id="dropArea" style="border:2px dashed #e2e2e2;padding:1rem;border-radius:8px;text-align:center;cursor:pointer">
          <div id="dropText">Arrastra una imagen aquí o haz clic para seleccionar</div>
          <img id="previewImg" src="" alt="" style="display:none;margin-top:.6rem;max-width:160px;max-height:120px;border-radius:6px;border:1px solid #ddd" />
        </div>
        <div class="controls" style="margin-top:.6rem">
          <button type="button" id="btnUpload">Subir</button>
          <button type="button" id="btnRefresh" style="background:#0a8a44">Actualizar galería</button>
        </div>
        <div id="progressWrap" style="display:none;margin-top:.6rem">
          <progress id="uploadProgress" value="0" max="100" style="width:100%"></progress>
          <div id="progressText" class="muted" style="margin-top:.3rem">0%</div>
        </div>
        <p id="uploadMsg" class="muted" style="margin-top:.6rem"></p>
      </form>

      <h3>Galería</h3>
      <div id="gallery" class="images"></div>

      <!-- Delete confirmation modal -->
      <div id="deleteModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:10000">
        <div style="background:#fff;padding:1rem;border-radius:8px;max-width:420px;margin:0 auto;box-shadow:0 8px 30px rgba(0,0,0,0.2)">
          <h3 id="modalTitle" style="margin-top:0">Confirmar eliminación</h3>
          <p id="modalText" class="muted">¿Estás segura de que quieres eliminar esta foto?</p>
          <img id="modalPreview" src="" alt="" style="width:100%;max-height:240px;object-fit:cover;border-radius:6px;border:1px solid #ddd;margin-bottom:.6rem" />
          <div style="display:flex;gap:.5rem;justify-content:flex-end">
            <button id="btnCancelDelete" style="background:#ddd;color:#111;padding:.5rem .8rem;border-radius:6px">Cancelar</button>
            <button id="btnConfirmDelete" style="background:#c62828;color:#fff;padding:.5rem .8rem;border-radius:6px">Eliminar</button>
          </div>
        </div>
      </div>
    </section>

  <!-- Footer notes removed so admin is accessible only by direct link -->
  </div>

  <script>
  // Base API: apunta al backend desplegado en Render
  const API_BASE = 'https://pagina-abuela.onrender.com';
  const loginCard = document.querySelector('.login-card');
  const adminSection = document.getElementById('adminSection');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnLogout = document.getElementById('btnLogout');
    const loginMsg = document.getElementById('loginMsg');
    const uploadMsg = document.getElementById('uploadMsg');
    const fileInput = document.getElementById('fileInput');
    const btnUpload = document.getElementById('btnUpload');
    const btnRefresh = document.getElementById('btnRefresh');
    const gallery = document.getElementById('gallery');

    function setAuth(token){
      const adminWelcome = document.getElementById('adminWelcome');
      if(token){
        localStorage.setItem('AUTH_TOKEN', token);
        if(loginCard) loginCard.style.display = 'none';
        if(adminWelcome) adminWelcome.style.display = 'block';
        adminSection.style.display = 'block';
        btnLogout.style.display = 'inline-block';
      } else {
        localStorage.removeItem('AUTH_TOKEN');
        if(loginCard) loginCard.style.display = 'block';
        if(adminWelcome) adminWelcome.style.display = 'none';
        adminSection.style.display = 'none';
        btnLogout.style.display = 'none';
      }
    }

    async function api(path, opts = {}){
      // Only use the Render backend as API source
      const token = localStorage.getItem('AUTH_TOKEN');
      const headers = Object.assign({}, opts.headers || {});
      if(token) headers['Authorization'] = 'Bearer ' + token;
      const url = API_BASE + '/api' + path;
      const res = await fetch(url, Object.assign({}, opts, {headers}));
      // If the backend returns 401, the token is invalid/expired — clear local session
      if(res.status === 401){
        setAuth(null);
        try{ localStorage.removeItem('AUTH_TOKEN'); }catch(e){}
      }
      return res;
    }

    let _selectedDelete = null; // filename selected for deletion

    async function refreshGallery(){
      gallery.innerHTML = '';
      try{
        const r = await api('/images');
        if(!r.ok) throw new Error('Error al solicitar imágenes');
        const data = await r.json();
        data.forEach(img => {
          // wrapper for image + actions
          const wrap = document.createElement('div');
          wrap.style.position = 'relative';
          wrap.style.width = '160px';
          wrap.style.height = '120px';

          const el = document.createElement('img');
          el.style.width = '100%'; el.style.height = '100%'; el.style.objectFit = 'cover'; el.style.borderRadius = '6px'; el.style.border = '1px solid #ddd';
          el.src = API_BASE + '/uploads/' + img.filename;
          el.alt = img.originalname || img.filename;
          el.dataset.filename = img.filename;

          // delete button (top-right)
          const btnDel = document.createElement('button');
          btnDel.textContent = 'Eliminar';
          btnDel.title = 'Eliminar esta imagen';
          btnDel.style.position = 'absolute';
          btnDel.style.top = '6px';
          btnDel.style.right = '6px';
          btnDel.style.padding = '4px 8px';
          btnDel.style.background = 'rgba(198,40,40,0.95)';
          btnDel.style.color = '#fff';
          btnDel.style.border = 'none';
          btnDel.style.borderRadius = '6px';
          btnDel.style.cursor = 'pointer';

          btnDel.addEventListener('click', (e) => {
            e.stopPropagation();
            _selectedDelete = img.filename;
            const modal = document.getElementById('deleteModal');
            const modalPreview = document.getElementById('modalPreview');
            modalPreview.src = API_BASE + '/uploads/' + img.filename;
            modal.style.display = 'flex';
          });

          wrap.appendChild(el);
          wrap.appendChild(btnDel);
          gallery.appendChild(wrap);
        });
      }catch(e){
        console.error(e);
      }
    }

    // attach events
    btnLogin.addEventListener('click', async () => {
      loginMsg.textContent = '';
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value.trim();
      if(!u || !p){ loginMsg.textContent = 'Rellena usuario y contraseña.'; return; }
      try{
        const res = await api('/login', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
        const j = await res.json();
        if(res.ok && j.token){ setAuth(j.token); loginMsg.textContent = 'Acceso correcto.'; refreshGallery(); } else { loginMsg.textContent = j.message || 'Login fallido'; }
      }catch(e){ loginMsg.textContent = 'Error de red'; }
    });

    btnRegister.addEventListener('click', async () => {
      loginMsg.textContent = '';
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value.trim();
      if(!u || !p){ loginMsg.textContent = 'Rellena usuario y contraseña.'; return; }
      try{
        const res = await api('/register', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:u,password:p})});
        const j = await res.json();
        if(res.ok){ loginMsg.textContent = 'Usuario registrado. Ahora entra con Entrar.'; } else { loginMsg.textContent = j.message || 'Registro fallido'; }
      }catch(e){ loginMsg.textContent = 'Error de red'; }
    });

    btnLogout.addEventListener('click', async () => {
      // try to notify backend to destroy session, then clear local auth
      try{
        await api('/logout', { method: 'POST' });
      }catch(err){ /* ignore network errors */ }
      setAuth(null);
    });

    // delete modal handlers
    const btnCancelDelete = document.getElementById('btnCancelDelete');
    const btnConfirmDelete = document.getElementById('btnConfirmDelete');
    const deleteModal = document.getElementById('deleteModal');

    btnCancelDelete.addEventListener('click', () => {
      _selectedDelete = null;
      deleteModal.style.display = 'none';
      document.getElementById('modalPreview').src = '';
    });

    btnConfirmDelete.addEventListener('click', async () => {
      if(!_selectedDelete) return;
      try{
        const res = await api('/images/' + encodeURIComponent(_selectedDelete), { method: 'DELETE' });
        const j = await res.json();
        if(res.ok){
          refreshGallery();
          _selectedDelete = null;
          deleteModal.style.display = 'none';
        } else {
          alert(j.message || 'No se pudo eliminar la imagen');
        }
      }catch(err){
        alert('Error de red eliminando la imagen');
      }
    });

    btnUpload.addEventListener('click', async () => {
      uploadMsg.textContent = '';
      const f = fileInput.files[0];
      if(!f){ uploadMsg.textContent = 'Selecciona un archivo.'; return; }
      // use XHR to track progress
      uploadFile(f);
    });

    // drag and drop + preview handling
    const dropArea = document.getElementById('dropArea');
    const previewImg = document.getElementById('previewImg');
    const progressWrap = document.getElementById('progressWrap');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');

    function showPreview(file){
      if(!file) { previewImg.style.display = 'none'; previewImg.src = ''; return; }
      const url = URL.createObjectURL(file);
      previewImg.src = url; previewImg.style.display = 'block';
    }

    dropArea.addEventListener('click', () => fileInput.click());
    dropArea.addEventListener('dragover', (e)=>{ e.preventDefault(); dropArea.style.borderColor = '#9b9b9b'; });
    dropArea.addEventListener('dragleave', ()=>{ dropArea.style.borderColor = '#e2e2e2'; });
    dropArea.addEventListener('drop', (e)=>{
      e.preventDefault(); dropArea.style.borderColor = '#e2e2e2';
      const dt = e.dataTransfer; const f = dt.files && dt.files[0];
      if(f){ fileInput.files = dt.files; showPreview(f); }
    });
    fileInput.addEventListener('change', (e)=>{ const f = e.target.files[0]; showPreview(f); });

    function uploadFile(file){
      progressWrap.style.display = 'block'; uploadProgress.value = 0; progressText.textContent = '0%';
      btnUpload.disabled = true; btnUpload.textContent = 'Subiendo...';
      const xhr = new XMLHttpRequest();
      const url = API_BASE + '/api/upload';
      xhr.open('POST', url, true);
      const token = localStorage.getItem('AUTH_TOKEN');
      if(token) xhr.setRequestHeader('Authorization', 'Bearer ' + token);
      xhr.upload.onprogress = function(e){ if(e.lengthComputable){ const pct = Math.round((e.loaded / e.total) * 100); uploadProgress.value = pct; progressText.textContent = pct + '%'; } };
      xhr.onload = function(){ btnUpload.disabled = false; btnUpload.textContent = 'Subir';
        try{
          const j = JSON.parse(xhr.responseText || '{}');
          if(xhr.status >=200 && xhr.status < 300){ uploadMsg.textContent = 'Subida correcta.'; showPreview(null); fileInput.value = ''; refreshGallery(); }
          else if(xhr.status === 401){
            // unauthorized: clear local session and inform user
            setAuth(null);
            uploadMsg.textContent = 'Tu sesión ha expirado o es inválida. Vuelve a iniciar sesión.';
          }
          else { uploadMsg.textContent = j.message || ('Error al subir: ' + xhr.status); }
        }catch(err){ uploadMsg.textContent = 'Respuesta inválida del servidor'; }
        progressWrap.style.display = 'none';
      };
      xhr.onerror = function(){ uploadMsg.textContent = 'Error de red durante la subida'; btnUpload.disabled = false; btnUpload.textContent = 'Subir'; progressWrap.style.display = 'none'; };
      const fd = new FormData(); fd.append('image', file);
      xhr.send(fd);
    }

    btnRefresh.addEventListener('click', () => refreshGallery());

    // If already logged in: validate stored token with the server before trusting it
    (async function(){
      const token = localStorage.getItem('AUTH_TOKEN');
      if(token){
        try{
          const res = await api('/me');
          if(res.ok){ setAuth(token); refreshGallery(); }
          else { setAuth(null); localStorage.removeItem('AUTH_TOKEN'); refreshGallery(); }
        }catch(err){
          // network error or server unreachable: clear local login to avoid stale UI
          setAuth(null); localStorage.removeItem('AUTH_TOKEN'); refreshGallery();
        }
      } else {
        // no token: public gallery
        refreshGallery();
      }
    })();

    // Keep-alive ping to backend every 5 minutes to help prevent sleeping on free hosting
    async function keepAliveAdmin(){
      try{
        // use api helper (will include token if available)
        await api('/info');
      }catch(err){
        console.debug('admin keepAlive failed', err);
      }
    }
    keepAliveAdmin();
    setInterval(keepAliveAdmin, 5 * 60 * 1000);
  </script>
</body>
</html>
